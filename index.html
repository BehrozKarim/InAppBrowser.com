<head>
    <meta name="viewport" content="user-scalable=no, width=device-width">
    <meta charset="utf-8">
    <title>inAppBrowser.com</title>
    <script defer data-domain="inappbrowser.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<h1>inAppBrowser.com</h1>
<p id="author">via <a target="_blank" href="https://twitter.com/KrauseFx">@KrauseFx</a></p>
<p class="subtitle">Verify if an app's in-app browser is injecting JavaScript code</p>
<p>For full context, please <a target="_blank" href="https://krausefx.com/blog/ios-privacy-instagram-and-facebook-can-track-anything-you-do-on-any-website-in-their-in-app-browser">read
    this first</a>.</p>

<div class="summaries" id="clean-summary">
    ‚úÖ &nbsp;Good news, it looks like the host app doesn't inject any JavaScript code.
</div>
<div class="summaries" id="medium-summary">
    üïµÔ∏è‚Äç‚ôÇÔ∏è &nbsp;Javascript injection detected. This does not necessarily imply malicious behaviour.
</div>
<div class="summaries" id="dangerous-summary">
    üö® &nbsp;JavaScript injection detected, with some potentially malicious or dangerous commands.
</div>
<ul id="all-comments">
</ul>

<div id="summary-note">
    The summary above is a list of commands detected, however is not a comprehensive list of what is happening. Below is the raw output that should be carefully studied to understand what is happening.

    <br /><br />
    <b>Disclaimer</b>: This tool works by overriding the most common JavaScript functions. The host app may still inject other commands, therefore the above list of commands is not a comprehensive list of what is happening. This tool cannot detect other
    app tracking that may be happening, such as custom gesture recognition, screenshot detection, or tracking of web request events. It is important to fully diagnose the raw output to form an understanding of how the app is using this data.‚Äù

</div>

<ol id="resultsList">
    <h3>Detected JavaScript Commands:</h3>
    <p id="none">None</p>
</ol>

<footer>
    <hr />
    <p>
        <a target="_blank" href="https://krausefx.com/blog/ios-privacy-instagram-and-facebook-can-track-anything-you-do-on-any-website-in-their-in-app-browser">
            About this tool
        </a> &nbsp; | &nbsp;
        <a target="_blank" href="https://krausefx.com/privacy">
            Additional privacy projects
        </a> &nbsp; | &nbsp; <a target="_blank" href="https://twitter.com/KrauseFx">@KrauseFx</a></p>
</footer>

<script type="text/javascript">
    // Fetch the nodes first, before we override the `document` methods
    const resultsList = document.getElementById("resultsList")
    const noneElement = document.getElementById("none")
    const cleanSummary = document.getElementById("clean-summary")
    const mediumSummary = document.getElementById("medium-summary")
    const dangerousSummary = document.getElementById("dangerous-summary")
    const allComments = document.getElementById("all-comments")
    const summary = document.getElementById("summary")
    const denyList = [
        "globalThis",
        "Object",
        "log",
        "parseInt",
        "Array",
        "Promise",
        "Reflect",
        "location",
        "onmouseout",
        "onmouseover",
        "onpointerout",
        "onmousemove",
        "onmouseleave",
        "onpointerrawupdate",
        "onpointerover",
        "onpointerenter",
        "onpointermove",
        "onmouseenter",
        "onpointerleave",
        "onscroll",
        "onpointerdown",
        "ongotpointercapture",
        "onpointercancel",
        "onlostpointercapture",
        "defaultView"
    ]

    const potentiallyDangerous = {
        "createElement('script')": "Injects external JavaScript code",
        "http://": "Uses an unencrypted URL, making the whole page insecure",
        "selectionchange": "Used to monitor text selections",
    }
    const neutralNotes = {
        "querySelector('input[type=password]": "Accessing all password fields: This could either mean the app has a password manager, or the app reads or enters passwords on the website"
    }
    const goodNotes = {
        "querySelector('head > meta[property=\"og:site_name\"]')": "Gets the website's name",
        "querySelector('head > meta[name=\"title\"]')": "Gets the website title",
        "querySelectorAll('head > link[rel~=\"icon\"]')": "Gets the website's favicon(s)",
        "getElementsByTagName('meta')": "Gets the page's metadata (like share text), this is unrelated to Meta the company",
    }

    let lastLevel = -1;

    function appendEvent(str, level) {
        noneElement.style.display = "none"
        let classesToUse = ""
        let comments = ""

        // Iterate over potentiallyDangerous, and see if any of them are included in the `str`
        for (const [key, value] of Object.entries(potentiallyDangerous)) {
            if (str.indexOf(key) > -1) {
                classesToUse += "danger"
                comments += `<p class='bad-comment'>^&nbsp;&nbsp;${value}</p>`
                allComments.innerHTML += `<li class='bad-in-comments'>${value}</li>`

                cleanSummary.style.display = "none"
                mediumSummary.style.display = "none"
                dangerousSummary.style.display = "block"
            }
        }
        // Iterate over neutralNotes, and see if any of them are included in the `str`
        for (const [key, value] of Object.entries(neutralNotes)) {
            if (str.indexOf(key) > -1) {
                classesToUse += "neutral"
                comments += `<p class='neutral-comment'>^&nbsp;&nbsp;${value}</p>`
                allComments.innerHTML += `<li class='neutral-in-comments'>${value}</li>`
            }
        }
        // Iterate over goodNotes, and see if any of them are included in the `str`
        for (const [key, value] of Object.entries(goodNotes)) {
            if (str.indexOf(key) > -1) {
                comments += `<p class='good-comment'>^&nbsp;&nbsp;${value}</p>`
                allComments.innerHTML += `<li class='good-in-comments'>${value}</li>`
            }
        }

        if (level < lastLevel) {
            classesToUse += "reducedLevel"
        }
        lastLevel = level;

        resultsList.innerHTML += "<li class='" + classesToUse + "'>" + str + comments + "</li>"
        if (cleanSummary.style.display !== "none") {
            cleanSummary.style.display = "none"
            mediumSummary.style.display = "block"
        }
    }

    // Function to help surround the value by ' if it's a string
    function renderParam(param) {
        if (typeof param === "string") {
            return "'" + param.replace("'", "\\'") + "'"
        } else {
            return param
        }
    }

    function overrideFunction(node, prop, level) {
        if (typeof node[prop] !== "function") {
            return;
        }
        try {
            const original = node[prop]
            node[prop] = function() {
                let str = prop;
                if (arguments) {
                    str = `${node.constructor.name}.${prop}(`
                    str += Object.values(arguments).map((arg) => renderParam(arg)).join(", ")
                    str += ")"
                }
                // `str` would be something like
                // "HTMLDocument.querySelector('head > meta['property="og:site_name"]')"

                appendEvent(str, level)
                const fakeObj = original.apply(node, arguments)
                if (fakeObj) {
                    investigate(fakeObj, level + 1);
                    const handler1 = {
                        get(target, prop, receiver) {
                            // For some reason, prop is always a string it seems
                            const spaces = "&nbsp;".repeat(level * 4)
                            if (Math.abs(parseInt(prop)) > 0 || prop == "0") {
                                appendEvent(spaces + fakeObj + "[" + renderParam(prop) + "]", level + 1)
                            } else {
                                appendEvent(spaces + fakeObj + "." + prop + "", level + 1)
                            }
                            return target[prop]
                        },
                        set(target, prop, value, receiver) {
                            const spaces = "&nbsp;".repeat(level * 4)
                            if (Math.abs(parseInt(prop)) > 0 || prop == "0") {
                                appendEvent(spaces + fakeObj + "[" + renderParam(prop) + "] = '" + value + "'", level + 1)
                            } else {
                                appendEvent(spaces + fakeObj + "." + prop + " = " + renderParam(value), level + 1)
                            }
                            return target[prop] = value
                        }
                    }

                    return new Proxy(fakeObj, handler1);
                }
                return fakeObj;
            }
            console.log("Sucessfully overwrote " + prop + " on " + node)
        } catch (e) {
            console.error(e);
        }
    }

    function investigate(node, level) {
        for (var prop in node) {
            if (denyList.includes(prop)) {
                continue;
            }
            value = node[prop]
            overrideFunction(node, prop, level)
        }
    }
    investigate(document, 1);
</script>

<style type="text/css">
    * {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        color: #353535;
    }
    
    .bad-comment {
        font-size: 0.8em;
        color: rgb(175, 0, 0);
        text-align: right;
        margin-bottom: 5px;
        width: 100%;
        margin-top: 0px;
        font-family: 'Courier New', Courier, monospace;
        padding: 5px;
    }
    
    .neutral-comment {
        font-size: 0.8em;
        color: rgb(0, 0, 175);
        text-align: right;
        margin-bottom: 5px;
        font-weight: bold;
        width: 100%;
        margin-top: 0px;
        font-family: 'Courier New', Courier, monospace;
        padding: 5px;
    }
    
    .good-comment {
        font-size: 0.8em;
        color: rgb(0, 187, 0);
        text-align: right;
        margin-bottom: 5px;
        width: 100%;
        font-weight: bold;
        margin-top: 0px;
        font-family: 'Courier New', Courier, monospace;
        padding: 5px;
    }
    
    .reducedLevel {
        margin-top: 30px;
    }
    
    body {
        background-color: #f0f0f0;
        max-width: 600px;
    }
    /* On larger screens only */
    
    @media only screen and (min-width: 600px) {
        body {
            margin: 40px;
        }
    }
    
    h1 {
        font-size: 1.5em;
    }
    
    ol {
        border: 1px solid #ccc;
        padding-left: 10px;
        padding-right: 35px;
        padding-top: 0px;
        padding-bottom: 10px;
        list-style: none;
    }
    
    a {
        color: #0085bd !important;
    }
    
    #resultsList h3 {
        margin-top: 10px;
        padding-top: 0px;
    }
    
    #resultsList {
        margin-left: -5px;
        margin-right: -5px;
        overflow-y: auto;
        max-width: cacl(100% - 10px);
        white-space: nowrap;
    }
    
    ol>li {
        margin-bottom: 0.5em;
        font-size: 0.8em;
        font-family: monospace;
    }
    
    #author {
        margin-top: -10px;
    }
    
    footer a {
        text-decoration: none;
    }
    
    footer p {
        text-align: center;
        font-size: 0.8em;
        margin-top: -15px;
        margin-bottom: 5px;
        color: #bbb !important;
    }
    
    .danger {
        color: rgba(255, 0, 0, 1);
        font-weight: bold;
    }
    
    hr {
        border: 0;
        height: 1px;
        margin-top: 25px;
        margin-bottom: 25px;
        background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(40, 40, 40, 0.3), rgba(0, 0, 0, 0));
        background-color: transparent !important;
    }
    
    .summaries {
        padding: 20px;
        margin-left: -5px;
        margin-right: -5px;
    }
    
    #clean-summary {
        background-color: rgba(0, 255, 0, 0.2)
    }
    
    #medium-summary {
        display: none;
        background-color: rgba(255, 255, 0, 0.3);
    }
    
    #dangerous-summary {
        display: none;
        background-color: rgba(255, 0, 0, 0.3);
    }
    
    #all-comments {
        padding-left: 10px;
        margin-top: -0px;
        border: 3px solid #ccc;
        border-top: none;
        list-style: inside;
        line-height: 1.8;
    }
    
    #all-comments>.in-comments {
        text-align: left !important;
        padding-left: 0px;
    }
    
    .subtitle {
        font-style: italic;
        font-size: 0.9em;
        color: #666;
    }
    
    #summary-note {
        font-style: italic;
        text-align: left;
        font-size: 0.9em;
    }
</style>